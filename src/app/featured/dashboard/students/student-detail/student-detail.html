<div class="main-card">
  <mat-toolbar color="primary">
    <span>Detalle de Chófer - {{ studentName }}</span>
  </mat-toolbar>

  <div class="toolbar-row">
    <button mat-icon-button (click)="prevMonth()" aria-label="Anterior mes"><mat-icon>chevron_left</mat-icon></button>

    <mat-form-field appearance="fill" class="month-select">
      <mat-select [value]="selectedMonthIndex" (selectionChange)="setMonth($event.value)">
        <mat-option *ngFor="let m of months; let i = index" [value]="i">{{ m }}</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-icon-button (click)="nextMonth()" aria-label="Siguiente mes"><mat-icon>chevron_right</mat-icon></button>

    <div class="stats-panel">
      <div class="stat">
        <div class="label">Comisión total</div>
        <div class="value">{{ totalCommission | currency:'USD':'symbol':'1.0-0' }}</div>
      </div>
      <div class="stat">
        <div class="label">Venta total</div>
        <div class="value">{{ totalSales | currency:'USD':'symbol':'1.0-0' }}</div>
      </div>
      <div class="stat">
        <div class="label">Promedio venta</div>
        <div class="value">{{ averageSale | currency:'USD':'symbol':'1.0-0' }}</div>
      </div>
      <div class="stat">
        <div class="label">Horas totales</div>
        <div class="value">{{ totalHours | number:'1.0-0' }}</div>
      </div>

      <div class="saving-indicator" *ngIf="isSaving">
        <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
        <span>Guardando...</span>
      </div>

      <!-- Overview quick stats for the whole year -->
      <div class="overview-panel" *ngIf="selectedMonthIndex === months.length - 1">
        <div class="overview-row">
          <div class="label">Venta acumulada (año)</div>
          <div class="value">{{ yearTotalSales | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Comisión acumulada (año)</div>
          <div class="value">{{ yearTotalCommission | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Aguinaldo (Junio)</div>
          <div class="value">{{ aguinaldoJune | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Aguinaldo (Diciembre)</div>
          <div class="value">{{ aguinaldoDecember | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Licencia (valor estimado)</div>
          <div class="value">{{ licenceAmount | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Días de licencia generados</div>
          <div class="value">{{ generatedLicenceDays | number:'1.2-2' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Salario vacacional (valor estimado)</div>
          <div class="value">{{ vacationPay | currency:'USD':'symbol':'1.0-0' }}</div>
        </div>
        <div class="overview-row">
          <div class="label">Comisión diciembre (año anterior)</div>
          <div class="value">
            <input type="text" inputmode="numeric" [value]="formatCurrencyValue(student?.lastDecemberCommission || 0, true)" (input)="onLastDecInput($any($event.target).value)" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-wrapper" *ngIf="selectedMonthIndex !== months.length - 1">
    <table class="detail-table">
      <thead>
        <tr>
          <th>Día</th>
          <th>Horas</th>
          <th>Detalle</th>
          <th>Venta</th>
          <th>Comisión chofer</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of days">
          <td>{{ row.day }}</td>
          <td><input type="number" [value]="row.hours" (input)="updateRow(row, 'hours', $any($event.target).value)" /></td>
          <td><input type="text" [value]="row.detail" (input)="updateRow(row, 'detail', $any($event.target).value)" /></td>
          <td>
            <div class="input-with-currency">
              <input type="text" inputmode="numeric" [value]="formatCurrencyValue(row.sale)" (input)="onSaleInput(row, $any($event.target).value)" />
            </div>
          </td>
          <td class="commission-cell">
            <div class="input-with-currency">
              <input type="text" inputmode="numeric" [value]="formatCurrencyValue((row.commissionOverride !== null && row.commissionOverride !== undefined) ? row.commissionOverride : calculateCommission(row))" (input)="onCommissionInput(row, $any($event.target).value)" />
            </div>
            <button mat-icon-button title="Auto" (click)="resetCommission(row)"><mat-icon>autorenew</mat-icon></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>


</div>
